package com.buoyancy.restaurant.controller

import com.buoyancy.common.model.dto.SuborderDto
import com.buoyancy.common.model.dto.rest.MessageDto
import com.buoyancy.common.model.entity.Suborder
import com.buoyancy.common.model.mapper.SuborderMapper
import com.buoyancy.common.utils.get
import com.buoyancy.restaurant.repository.SuborderRepository
import com.buoyancy.restaurant.service.SuborderService
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.context.MessageSource
import org.springframework.data.domain.Page
import org.springframework.data.domain.Pageable
import org.springframework.web.bind.annotation.*
import java.util.*

@RestController
@RequestMapping("/suborders")
class SuborderController {

    @Autowired
    lateinit var repo: SuborderRepository
    @Autowired
    lateinit var mapper: SuborderMapper
    @Autowired
    lateinit var service: SuborderService
    @Autowired
    private lateinit var messages : MessageSource

    private val updatedMessage = messages.get("rest.response.resource.updated")

    @GetMapping()
    fun getSuborders(pageable: Pageable): Page<SuborderDto> {
        return repo.findAll(pageable).map { mapper.toDto(it) }
    }

    @PostMapping("/{id}/accept")
    fun acceptOrder(@PathVariable id: UUID): MessageDto {
        service.markSuborderAsPreparing(id)
        val message = messages.get("rest.response.orders.preparing", arrayOf(id))
        return MessageDto(200, message)
    }

    @PostMapping("/{id}/postpone")
    fun postponeOrderPreparation(@PathVariable id: UUID, @RequestParam("reason") reason: String): MessageDto {
        service.postponeSuborder(id)
        val message = messages.get("rest.response.orders.postponed", arrayOf(id))
        return MessageDto(200, message)
    }

    @PostMapping("/{id}/finish")
    fun finishOrderPreparation(@PathVariable id: UUID): MessageDto {
        service.markSuborderAsReady(id)
        val message = messages.get("rest.response.orders.finished", arrayOf(id))
        return MessageDto(200, message)
    }

    @GetMapping("/restaurant/{restaurantId}")
    fun getSubordersByRestaurant(@PathVariable restaurantId: UUID, pageable: Pageable): Page<Suborder> {
        return service.getSubordersByRestaurant(restaurantId, pageable)
    }

    @GetMapping("/{id}")
    fun getSuborder(@PathVariable id: UUID): Suborder {
        return service.getSuborder(id)
    }
}