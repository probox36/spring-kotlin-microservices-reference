package com.buoyancy.common.model.mapper

import com.buoyancy.common.model.dto.OrderDto
import com.buoyancy.common.model.entity.Order
import com.buoyancy.common.model.entity.Product
import com.buoyancy.common.model.entity.User
import com.buoyancy.common.repository.ProductRepository
import com.buoyancy.common.repository.UserRepository
import org.mapstruct.Mapper
import org.mapstruct.Mapping
import org.springframework.beans.factory.annotation.Autowired
import java.util.*

@Mapper(componentModel = "spring")
abstract class OrderMapper {

    @Autowired
    protected lateinit var userRepo: UserRepository

    @Autowired
    protected lateinit var productRepo: ProductRepository

    @Mapping(target = "user", expression = "java(getUserProxy(dto.getUserId()))")
    @Mapping(target = "items", expression = "java(mapIdsToProducts(dto.getItems()))")
    abstract fun toEntity(dto: OrderDto): Order

    @Mapping(target = "userId", expression = "java(order.getUser().getId())")
    @Mapping(target = "items", expression = "java(mapProductsToIds(order.getItems()))")
    abstract fun toDto(order: Order): OrderDto

    protected fun getUserProxy(userId: UUID): User {
        return userRepo.getReferenceById(userId)
    }

    protected fun mapIdsToProducts(productIds: List<UUID>): List<Product> {
        return productIds.map { productRepo.getReferenceById(it) }
    }

    protected fun mapProductsToIds(productIds: List<Product>): List<UUID?> {
        return productIds.map { it.id }
    }
}